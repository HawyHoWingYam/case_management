本阶段的目标是将运营数据转化为直观的、可操作的业务洞察，为管理层提供决策支持。

#### **1. 后端 (Nest.js): 数据聚合与统计 API**

**目标**：创建高效的 API 端点，专门用于提供前端仪表板所需的聚合统计数据，避免前端进行复杂的计算。

- **1.1. Git 分支**: `git checkout -b feature/backend-reporting-api`。
    
- **1.2. 增强数据模型 (Prisma)**:
    
    - 在 `prisma/schema.prisma` 的 `Case` 模型中，添加一个 `processingDuration` (整数类型，可为空) 字段。
        
    - 当案件状态变为 "Completed" 时（在阶段3的 `approve` 逻辑中），计算 `CreatedOn` 和 `CompletedOn` 之间的天数差，并存入此字段。这将极大简化后续的平均时长计算。
        
- **1.3. 创建统计模块 (`StatsModule`)**:
    
    - 使用 NestJS CLI 创建 `stats` 模块。
        
    - **创建运营概览 API (`GET /api/stats/overview`)**:
        
        - 此端点将返回一组关键绩效指标 (KPIs)，例如：进行中的案件总数、本月已完成案件数、平均处理时长等。
            
        - 使用 Prisma 的聚合功能 (`_count`, `_avg`) 来高效计算这些值。
            
    - **创建绩效图表 API (`GET /api/stats/performance`)**:
        
        - 此端点将返回用于图表展示的数据。例如，按 `CaseType` 分组的案件数量，或每位 `Caseworker` 已完成的案件数量。
            
- **1.4. API 保护**: 确保所有 `stats` 模块的 API 都受到保护，仅限 `Chair` 角色的用户访问。
    
- **1.5. Git 提交与合并**: 完成 API 开发和测试后，提交代码并创建 PR。
    

#### **2. 前端 (Next.js): 构建交互式仪表板**

**目标**：创建一个美观、易于理解的数据可视化界面。

- **2.1. Git 分支**: `git checkout -b feature/frontend-dashboard`。
    
- **2.2. 安装图表库**: `npm install recharts`。Recharts 是一个与 React 配合良好的流行图表库。
    
- **2.3. 创建报告页面 (`/reports`)**:
    
    - 创建一个新的页面，并确保其路由受到保护，仅对 `Chair` 角色可见。在导航栏中添加入口。
        
    - 使用 `react-query` 调用后端的 `/api/stats/*` 系列 API 来获取数据。
        
- **2.4. 开发仪表板组件**:
    
    - **KPI 卡片组**: 在页面顶部，用一系列 `Card` 组件展示从 `/api/stats/overview` 获取的关键指标，如"进行中案件"、"平均处理时长"等。
        
    - **案件类型分布图**: 使用 Recharts 的 `PieChart` (饼图) 或 `BarChart` (条形图) 来展示不同 `CaseType` 的案件数量分布。
        
    - **员工绩效排行榜**: 使用 Recharts 的 `BarChart`，展示每位 Caseworker 在特定时间范围内（如过去30天）完成的案件数量。
        
- **2.5. 添加筛选功能 (可选增强)**:
    
    - 在页面上添加日期范围选择器，允许 Chair 查看特定时间段内的数据报告。选择后，前端将带上时间参数重新调用 API 获取数据。
        
- **2.6. Git 提交与合并**: 完成仪表板的开发和响应式设计后，提交代码并创建 PR。
    

#### **3. 系统优化与监控**

**目标**：完善系统性能和监控机制，确保应用的稳定性和可维护性。

- **3.1. 后端性能优化**:
    
    - **数据库查询优化**: 为常用查询添加数据库索引，特别是涉及案件状态、创建时间和用户角色的查询。
        
    - **缓存机制**: 使用 Redis 或内存缓存实现统计数据的缓存，减少数据库负载。设置合理的缓存过期时间。
        
    - **API 响应优化**: 实现数据分页功能，避免一次性返回大量数据。对统计 API 实现缓存策略。
        
- **3.2. 内置监控和日志系统**:
    
    - **应用日志**: 集成结构化日志记录（如 Winston），记录关键业务操作和错误信息。
        
    - **健康检查端点**: 创建 `GET /api/health` 端点，用于监控应用和数据库连接状态。
        
    - **错误处理**: 实现全局异常过滤器，统一处理和记录应用错误。
        
- **3.3. 定期报告功能**:
    
    - **后端定期任务**: 使用 `@nestjs/schedule` 实现定期任务，生成周报数据并存储到数据库。
        
    - **报告导出功能**: 创建 API 端点，支持将统计数据导出为 CSV 或 PDF 格式。
        
    - **前端报告下载**: 在仪表板页面添加"导出报告"按钮，用户可以下载详细的数据报告。
        
- **3.4. 系统备份策略**:
    
    - **数据库备份**: 配置数据库的定期备份机制，确保数据安全。
        
    - **配置管理**: 使用环境变量管理所有配置，支持不同环境的配置切换。
        

#### **4. 部署与收尾 (Deployment & Finalization)**

**目标**：完成所有开发工作，准备项目上线。

- **4.1. 环境变量配置**:
    
    - 为生产环境 (Vercel/AWS) 准备 `.env.production` 文件，包含生产数据库连接字符串、JWT 密钥、Redis 连接信息等。
        
    - 配置不同环境的数据库连接、日志级别和缓存设置。
        
- **4.2. 部署**:
    
    - **后端 (Nest.js)**: 可以打包成一个 Docker 镜像，部署到 AWS Fargate 或其他容器服务。配置负载均衡和自动扩缩容。
        
    - **前端 (Next.js)**: Vercel 是最佳选择，它提供了与 Next.js 的无缝集成。只需将 GitHub 仓库连接到 Vercel 项目即可实现自动化部署。
        
    - **数据库**: 使用云数据库服务（如 AWS RDS 或 Vercel Postgres），确保数据的高可用性。
        
- **4.3. 最终回归测试**: 在生产环境中，对整个应用进行一次全面的回归测试，确保所有功能按预期工作。
    
- **4.4. 项目文档**: 撰写并完善 `README.md` 文件，包含项目介绍、技术栈、如何启动本地开发环境、环境变量说明以及部署指南。
    
- **4.5. 用户文档**: 创建用户使用手册，说明不同角色的操作流程和功能使用方法。

完成阶段 4 后，您的项目不仅具备了完整的业务处理能力，还拥有了强大的数据分析和决策支持功能，以及完善的监控和维护机制，成为了一个真正意义上成熟的业务应用。