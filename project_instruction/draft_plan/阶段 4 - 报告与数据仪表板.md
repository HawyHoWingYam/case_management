本阶段的目标是将运营数据转化为直观的、可操作的业务洞察，为管理层提供决策支持。

#### **1. 后端 (Nest.js): 数据聚合与统计 API**

**目标**：创建高效的 API 端点，专门用于提供前端仪表板所需的聚合统计数据，避免前端进行复杂的计算。

- **1.1. Git 分支**: `git checkout -b feature/backend-reporting-api`。
    
- **1.2. 增强数据模型 (Prisma)**:
    
    - 在 `prisma/schema.prisma` 的 `Case` 模型中，添加一个 `processingDuration` (整数类型，可为空) 字段。
        
    - 当案件状态变为 "Completed" 时（在阶段3的 `approve` 逻辑中），计算 `CreatedOn` 和 `CompletedOn` 之间的天数差，并存入此字段。这将极大简化后续的平均时长计算。
        
- **1.3. 创建统计模块 (`StatsModule`)**:
    
    - 使用 NestJS CLI 创建 `stats` 模块。
        
    - **创建运营概览 API (`GET /api/stats/overview`)**:
        
        - 此端点将返回一组关键绩效指标 (KPIs)，例如：进行中的案件总数、本月已完成案件数、平均处理时长等。
            
        - 使用 Prisma 的聚合功能 (`_count`, `_avg`) 来高效计算这些值。
            
    - **创建绩效图表 API (`GET /api/stats/performance`)**:
        
        - 此端点将返回用于图表展示的数据。例如，按 `CaseType` 分组的案件数量，或每位 `Caseworker` 已完成的案件数量。
            
- **1.4. API 保护**: 确保所有 `stats` 模块的 API 都受到保护，仅限 `Chair` 角色的用户访问。
    
- **1.5. Git 提交与合并**: 完成 API 开发和测试后，提交代码并创建 PR。
    

#### **2. 前端 (Next.js): 构建交互式仪表板**

**目标**：创建一个美观、易于理解的数据可视化界面。

- **2.1. Git 分支**: `git checkout -b feature/frontend-dashboard`。
    
- **2.2. 安装图表库**: `npm install recharts`。Recharts 是一个与 React 配合良好的流行图表库。
    
- **2.3. 创建报告页面 (`/reports`)**:
    
    - 创建一个新的页面，并确保其路由受到保护，仅对 `Chair` 角色可见。在导航栏中添加入口。
        
    - 使用 `react-query` 调用后端的 `/api/stats/*` 系列 API 来获取数据。
        
- **2.4. 开发仪表板组件**:
    
    - **KPI 卡片组**: 在页面顶部，用一系列 `Card` 组件展示从 `/api/stats/overview` 获取的关键指标，如“进行中案件”、“平均处理时长”等。
        
    - **案件类型分布图**: 使用 Recharts 的 `PieChart` (饼图) 或 `BarChart` (条形图) 来展示不同 `CaseType` 的案件数量分布。
        
    - **员工绩效排行榜**: 使用 Recharts 的 `BarChart`，展示每位 Caseworker 在特定时间范围内（如过去30天）完成的案件数量。
        
- **2.5. 添加筛选功能 (可选增强)**:
    
    - 在页面上添加日期范围选择器，允许 Chair 查看特定时间段内的数据报告。选择后，前端将带上时间参数重新调用 API 获取数据。
        
- **2.6. Git 提交与合并**: 完成仪表板的开发和响应式设计后，提交代码并创建 PR。
    

#### **3. 自动化 (n8n): 定期报告与异常监控**

**目标**：利用 n8n 实现主动的数据推送和异常情况预警。

- **3.1. n8n: 每周运营摘要报告**:
    
    - **触发器**: 使用 `Schedule` 节点，设置为每周一早上 9 点运行。
        
    - **逻辑**:
        
        1. 连接一个 `HTTP Request` 节点，调用后端的 `/api/stats/overview` API 来获取最新的 KPI 数据。
            
        2. 使用 `Set` 节点，将获取到的 JSON 数据格式化成一段易于阅读的文本或 HTML。
            
    - **执行器**: 使用 `Send Email` 节点，将格式化后的摘要报告发送给所有 `Chair` 角色的用户。
        
- **3.2. n8n: 案件积压预警工作流 (可选增强)**:
    
    - **触发器**: `Schedule` 节点，设置为每天检查一次。
        
    - **逻辑**:
        
        1. 使用数据库节点，查询创建时间超过 (例如) 14 天但状态仍为 "Pending Review" 或 "Pending Acceptance" 的案件。
            
        2. 如果查询结果不为空，则进入下一步。
            
    - **执行器**: 发送一封预警邮件给 `Chair`，提醒他们“有 [N] 个案件可能已被积压，请及时处理”，并附上案件 ID 列表。
        

#### **4. 部署与收尾 (Deployment & Finalization)**

**目标**：完成所有开发工作，准备项目上线。

- **4.1. 环境变量配置**:
    
    - 为生产环境 (Vercel/AWS) 准备 `.env.production` 文件，包含生产数据库连接字符串、JWT 密钥、n8n Webhook URL 等。
        
- **4.2. 部署**:
    
    - **后端 (Nest.js)**: 可以打包成一个 Docker 镜像，部署到 AWS Fargate 或其他容器服务。
        
    - **前端 (Next.js)**: Vercel 是最佳选择，它提供了与 Next.js 的无缝集成。只需将 GitHub 仓库连接到 Vercel 项目即可实现自动化部署。
        
- **4.3. 最终回归测试**: 在生产环境中，对整个应用进行一次全面的回归测试，确保所有功能按预期工作。
    
- **4.4. 项目文档**: 撰写并完善 `README.md` 文件，包含项目介绍、技术栈、如何启动本地开发环境、环境变量说明以及部署指南。
    

完成阶段 4 后，您的项目不仅具备了完整的业务处理能力，还拥有了强大的数据分析和决策支持功能，成为了一个真正意义上成熟的业务应用。