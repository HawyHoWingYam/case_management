本阶段我们将完成整个案件处理流程的闭环，实现从请求完成到最终审批的全过程，并为每个案件提供完整的操作日志。

#### **1. 后端 (Nest.js): 终结工作流与日志系统 API**

**目标**：开发用于完成、审批和记录案件历史的 API。

- **1.1. Git 分支**: `git checkout -b feature/backend-case-closure`。
    
- **1.2. Caseworker - 请求完成 API (`PATCH /api/cases/:id/request-completion`)**:
    
    - 创建此端点，并使用 `@Roles('Caseworker')` 保护。
        
    - 服务逻辑：验证请求者是否为当前指派的 Caseworker。将案件 `Status` 从 "InProgress" 更新为 "Pending Completion Review"。
        
    - **创建通知**: 成功后，调用通知服务为所有 Chair 用户创建通知记录。
        
- **1.3. Chair - 最终审批 API**:
    
    - **批准 (`PATCH /api/cases/:id/approve`)**:
        
        - 使用 `@Roles('Chair')` 保护。
            
        - 服务逻辑：将 `Status` 更新为 "Completed"，并记录 `CompletedOn` 的当前日期。
            
    - **拒绝 (`PATCH /api/cases/:id/reject`)**:
        
        - 使用 `@Roles('Chair')` 保护。
            
        - 服务逻辑：将 `Status` 更新为 "Rejected"。
            
    - **创建通知**: 两种操作成功后，都调用通知服务为该案件的 Caseworker 创建通知记录。
        
- **1.4. 案件日志 API**:
    
    - **添加日志 (`POST /api/cases/:id/logs`)**:
        
        - 使用 `@Roles('Chair', 'Caseworker')` 保护。
            
        - 服务逻辑：在 `Case_Log` 表中创建一条新记录，包含 `LogEntry` (备注内容)、`CaseID` 和 `CreatedByUserID` (从 JWT 中获取)。
            
    - **获取日志 (`GET /api/cases/:id/logs`)**:
        
        - 创建此端点，用于获取指定案件的所有历史记录，按创建时间降序排列。
            
- **1.5. Git 提交与合并**: 完成 API 开发和相关测试后，提交代码并创建 PR 到 `develop` 分支。
    

#### **2. 前端 (Next.js): 实现最终操作与历史记录视图**

**目标**：在前端界面上提供最终的操作按钮，并清晰地展示案件的完整生命周期。

- **2.1. Git 分支**: `git checkout -b feature/frontend-case-closure`。
    
- **2.2. 实现 Caseworker 请求完成功能**:
    
    - 在案件详情页 (`/cases/[id]`)，当登录用户是该案件的 Caseworker 且案件状态为 "InProgress" 时，显示 "请求完成" 按钮。
        
    - 点击后，调用 `PATCH /api/cases/:id/request-completion` API，并提供用户反馈。
        
- **2.3. 实现 Chair 最终审批功能**:
    
    - 在案件详情页，当登录用户是 Chair 且案件状态为 "Pending Completion Review" 时，显示 "批准完成" 和 "拒绝案件" 两个按钮。
        
    - 点击按钮后，分别调用对应的后端 API，并使用 `useMutation` 优雅地处理 UI 更新。
        
- **2.4. 开发案件历史记录组件 (`CaseLogHistory`)**:
    
    - 在案件详情页下方，创建一个新区域用于显示历史记录。
        
    - 使用 `react-query` 的 `useQuery` 调用 `GET /api/cases/:id/logs` API 获取数据。
        
    - 将日志条目以时间线的形式清晰展示，包含操作人、操作时间及备注内容。
        
- **2.5. 开发手动添加备注功能 (`AddLogForm`)**:
    
    - 在历史记录区域上方，为 Chair 和 Caseworker 提供一个文本输入框和"添加备注"按钮。
        
    - 提交后，调用 `POST /api/cases/:id/logs` API，并在成功后自动刷新历史记录列表。
        
- **2.6. Git 提交与合并**: 完成所有前端功能和组件后，提交代码并创建 PR。
    

#### **3. 增强通知系统**

**目标**：扩展内部通知系统，支持案件完成流程的相关通知。

- **3.1. 后端 - 扩展通知服务**:
    
    - 在 `NotificationsService` 中新增方法，用于创建案件完成请求和最终审批结果的通知。
        
    - 实现通知模板功能，根据不同的事件类型生成标准化的通知消息。
        
    - 为通知添加链接功能，用户点击通知可直接跳转到相关案件页面。
        
- **3.2. 前端 - 增强通知界面**:
    
    - 在通知列表中增加通知类型的图标标识（如完成请求、审批结果等）。
        
    - 实现通知的分类筛选功能，用户可按类型查看通知。
        
    - 添加通知的批量操作功能，如全部标记为已读。
        
- **3.3. 实时通知**:
    
    - 考虑使用 Server-Sent Events (SSE) 或 WebSocket 实现实时通知推送。
        
    - 在用户界面中显示新通知的实时提醒（如浏览器通知或页面提示）。
        

#### **4. 自动化与开发运维 (Automation & DevOps)**

**目标**：确保新增功能的代码质量，并进行完整的端到端测试。

- **4.1. GitHub Actions**:
    
    - CI 流程将自动运行为本阶段新增的后端 API 编写的集成测试。
        
    - 确保所有 PR 在合并到 `develop` 分支前，都通过了代码审查和所有自动化检查。
        
- **4.2. 端到端测试 (E2E)**:
    
    - 在此阶段完成后，应手动执行一次完整的端到端测试。
        
    - **测试场景**:
        
        1. Clerk 创建一个新案件。
            
        2. Chair 收到通知，查看并指派给一个 Caseworker。
            
        3. Caseworker 收到通知，接受案件。
            
        4. Caseworker 完成工作，请求完成。
            
        5. Chair 收到通知，进行最终审批（批准）。
            
    - 验证每一步之后，相关人员是否都收到了正确的内部通知。
        
- **4.3. 系统性能优化**:
    
    - 对数据库查询进行优化，特别是涉及多表关联的案件查询。
        
    - 实现缓存机制，提高通知查询和案件列表的响应速度。
        
    - 添加数据库索引，优化案件历史记录的查询性能。
        

完成阶段 3 后，您的应用将具备一个完整、健壮、可追溯的案件管理核心流程。系统的所有核心功能都已实现，用户可以通过内部通知系统及时了解案件状态变化。接下来，我们可以进入 **阶段 4**，专注于数据分析、报告和仪表板的开发，从数据中挖掘价值。