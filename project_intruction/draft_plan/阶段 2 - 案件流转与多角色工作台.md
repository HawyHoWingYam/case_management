本阶段我们将把业务流程的蓝图变为现实，为不同角色提供定制化的视图和操作，并深化自动化流程。

#### **1. 前端 (Next.js): 统一的仪表板与案件列表**

**目标**：创建一个所有角色共享的仪表板，并根据登录用户的角色动态展示不同的案件列表和操作。

- **1.1. Git 分支**: `git checkout -b feature/frontend-dashboard`。
    
- **1.2. 创建主仪表板页面 (`/`)**:
    
    - 设计一个通用的仪表板布局。
        
    - 使用 `react-query` 或 `SWR` 来获取案件列表。查询将是动态的，例如 `GET /api/cases?view=new` 或 `GET /api/cases?view=my_cases`。
        
    - 根据登录用户的角色 (`authStore.user.role`)，决定调用哪个查询，并显示对应的标题，如“待审核案件” (Chair) 或“我的处理中案件” (Caseworker)。
        
- **1.3. 开发可重用的案件列表组件**:
    
    - 创建一个 `CaseList` 组件，用于以表格或卡片形式展示案件。
        
    - 表格应包含关键信息：`CaseID`, `Priority`, `Status`, `CreatedOn` 等。
        
    - 使用 `shadcn/ui` 的 `Table` 组件，并确保其在移动设备上可以响应式地横向滚动或改变布局。
        
- **1.4. 创建案件详情页 (`/cases/[id]`)**:
    
    - 这是一个动态路由页面，用于显示单个案件的所有详细信息。
        
    - 当用户从列表点击一个案件时，导航到此页面。
        
    - 页面将根据案件的状态和用户角色，动态显示不同的操作按钮（如“指派”、“接受”、“完成”）。
        
- **1.5. Git 提交与合并**: 完成仪表板基础后，提交代码并创建 PR 到 `develop` 分支。
    

#### **2. 后端 (Nest.js): 案件生命周期管理 API**

**目标**：开发一系列受保护的 API 端点，用于驱动案件状态的流转。

- **2.1. Git 分支**: `git checkout -b feature/backend-case-lifecycle`。
    
- **2.2. 增强案件查询 API (`GET /api/cases`)**:
    
    - 扩展 `CasesController` 中的 `findAll` 方法，使其接受一个查询参数 `view`。
        
    - 在 `CasesService` 中，根据 `view` 的值 (`new`, `pending_acceptance`, `in_progress` 等) 和用户的角色/ID (从 JWT 中获取) 来构建不同的 Prisma 查询。
        
- **2.3. Chair - 指派案件 API (`PATCH /api/cases/:id/assign`)**:
    
    - 创建此端点，并使用 `@Roles('Chair')` 保护。
        
    - 请求体 (Body) 中应包含 `assignedCaseworkerId`。
        
    - 服务逻辑：更新案件的 `AssignedCaseworkerID` 和 `Status` (从 "Pending Review" 到 "Pending Acceptance")。
        
    - **触发 n8n**: 成功后，调用 n8n 的 "案件指派通知" Webhook。
        
- **2.4. Caseworker - 接受/拒绝案件 API**:
    
    - **接受 (`PATCH /api/cases/:id/accept`)**:
        
        - 使用 `@Roles('Caseworker')` 保护。
            
        - 服务逻辑：**实现业务规则** (检查该 Caseworker 是否已有超过5个 "InProgress" 的案件)。如果通过，则将状态更新为 "InProgress"。
            
        - **触发 n8n**: 成功后，调用 n8n 的 "案件已接受" Webhook，通知 Chair。
            
    - **拒绝 (`PATCH /api/cases/:id/reject`)**:
        
        - 服务逻辑：将状态更新回 "Pending Review"，并清空 `AssignedCaseworkerID`。
            
        - **触发 n8n**: 成功后，通知 Chair 案件被退回。
            
- **2.5. Git 提交与合并**: 完成 API 开发后，编写相应的单元/集成测试，然后提交并创建 PR。
    

#### **3. 前端 (Next.js): 实现角色特定操作**

**目标**：在前端界面上为 Chair 和 Caseworker 提供实际可用的操作按钮。

- **3.1. Git 分支**: `git checkout -b feature/frontend-role-actions`。
    
- **3.2. Chair - 指派功能**:
    
    - 在案件详情页，当 Chair 查看状态为 "Pending Review" 的案件时，显示“指派”按钮和一个用户选择器（用于选择 Caseworker）。
        
    - 点击“指派”后，调用 `PATCH /api/cases/:id/assign` API。使用 `react-query` 的 `useMutation` 来处理 API 调用，并自动刷新案件数据。
        
- **3.3. Caseworker - 接受/拒绝功能**:
    
    - 在案件详情页，当 Caseworker 查看指派给自己的、状态为 "Pending Acceptance" 的案件时，显示“接受”和“拒绝”按钮。
        
    - 点击按钮后，分别调用对应的后端 API，并使用 `useMutation` 处理后续的 UI 更新和用户反馈。
        
- **3.4. 错误处理与用户反馈**:
    
    - 对所有的 API 调用进行完善的错误处理。例如，当 Caseworker 接受案件因超出上限而失败时，应在界面上通过 `Toast` 或 `Alert` 组件明确告知用户原因。
        
- **3.5. Git 提交与合并**: 完成所有角色的前端操作逻辑后，提交代码并创建 PR。
    

#### **4. 自动化与开发运维 (Automation & DevOps)**

**目标**：扩展 n8n 工作流，使其覆盖本阶段新增的业务流程。

- **4.1. n8n: 案件指派通知工作流**:
    
    - **触发器**: 创建一个新的 Webhook 节点，供 "指派案件 API" 调用。
        
    - **逻辑**: 从 Webhook 获取 `CaseID` 和 `AssignedCaseworkerID`。使用 `Dataverse/PostgreSQL` 节点，根据 `AssignedCaseworkerID` 查询 Caseworker 的邮箱地址。
        
    - **执行器**: 使用 `Send Email` 节点，向该 Caseworker 的邮箱发送一封包含案件详情和直接访问链接的通知邮件。
        
- **4.2. n8n: 案件状态变更通用通知工作流**:
    
    - 可以创建一个更通用的 Webhook，用于处理多种状态变更（如接受、拒绝、完成等）。
        
    - 工作流内部使用 `Switch` 节点，根据传入的状态，决定发送何种内容的通知以及通知给谁（Chair 或 Caseworker）。
        
- **4.3. GitHub Actions**:
    
    - 继续使用阶段 1 建立的 CI 流程。
        
    - 考虑为后端添加自动化 API 测试步骤，例如使用 `supertest`，确保核心的业务逻辑在每次提交时都得到验证。
        

完成阶段 2 后，您的应用程序将拥有一个完整的多角色协作闭环。案件可以被创建、指派、接受和处理。这是整个项目的核心骨架。接下来，我们将进入 **阶段 3**，专注于案件的完成、审批和历史记录功能。