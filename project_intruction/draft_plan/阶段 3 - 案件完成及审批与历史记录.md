本阶段我们将完成整个案件处理流程的闭环，实现从请求完成到最终审批的全过程，并为每个案件提供完整的操作日志。

#### **1. 后端 (Nest.js): 终结工作流与日志系统 API**

**目标**：开发用于完成、审批和记录案件历史的 API。

- **1.1. Git 分支**: `git checkout -b feature/backend-case-closure`。
    
- **1.2. Caseworker - 请求完成 API (`PATCH /api/cases/:id/request-completion`)**:
    
    - 创建此端点，并使用 `@Roles('Caseworker')` 保护。
        
    - 服务逻辑：验证请求者是否为当前指派的 Caseworker。将案件 `Status` 从 "InProgress" 更新为 "Pending Completion Review"。
        
    - **触发 n8n**: 成功后，调用 n8n 的 "请求完成审批" Webhook。
        
- **1.3. Chair - 最终审批 API**:
    
    - **批准 (`PATCH /api/cases/:id/approve`)**:
        
        - 使用 `@Roles('Chair')` 保护。
            
        - 服务逻辑：将 `Status` 更新为 "Completed"，并记录 `CompletedOn` 的当前日期。
            
    - **拒绝 (`PATCH /api/cases/:id/reject`)**:
        
        - 使用 `@Roles('Chair')` 保护。
            
        - 服务逻辑：将 `Status` 更新为 "Rejected"。
            
    - **触发 n8n**: 两种操作成功后，都调用 n8n 的 "最终结果通知" Webhook，将结果告知 Caseworker。
        
- **1.4. 案件日志 API**:
    
    - **添加日志 (`POST /api/cases/:id/logs`)**:
        
        - 使用 `@Roles('Chair', 'Caseworker')` 保护。
            
        - 服务逻辑：在 `Case_Log` 表中创建一条新记录，包含 `LogEntry` (备注内容)、`CaseID` 和 `CreatedByUserID` (从 JWT 中获取)。
            
    - **获取日志 (`GET /api/cases/:id/logs`)**:
        
        - 创建此端点，用于获取指定案件的所有历史记录，按创建时间降序排列。
            
- **1.5. Git 提交与合并**: 完成 API 开发和相关测试后，提交代码并创建 PR 到 `develop` 分支。
    

#### **2. 前端 (Next.js): 实现最终操作与历史记录视图**

**目标**：在前端界面上提供最终的操作按钮，并清晰地展示案件的完整生命周期。

- **2.1. Git 分支**: `git checkout -b feature/frontend-case-closure`。
    
- **2.2. 实现 Caseworker 请求完成功能**:
    
    - 在案件详情页 (`/cases/[id]`)，当登录用户是该案件的 Caseworker 且案件状态为 "InProgress" 时，显示 “请求完成” 按钮。
        
    - 点击后，调用 `PATCH /api/cases/:id/request-completion` API，并提供用户反馈。
        
- **2.3. 实现 Chair 最终审批功能**:
    
    - 在案件详情页，当登录用户是 Chair 且案件状态为 "Pending Completion Review" 时，显示 “批准完成” 和 “拒绝案件” 两个按钮。
        
    - 点击按钮后，分别调用对应的后端 API，并使用 `useMutation` 优雅地处理 UI 更新。
        
- **2.4. 开发案件历史记录组件 (`CaseLogHistory`)**:
    
    - 在案件详情页下方，创建一个新区域用于显示历史记录。
        
    - 使用 `react-query` 的 `useQuery` 调用 `GET /api/cases/:id/logs` API 获取数据。
        
    - 将日志条目以时间线的形式清晰展示，包含操作人、操作时间及备注内容。
        
- **2.5. 开发手动添加备注功能 (`AddLogForm`)**:
    
    - 在历史记录区域上方，为 Chair 和 Caseworker 提供一个文本输入框和“添加备注”按钮。
        
    - 提交后，调用 `POST /api/cases/:id/logs` API，并在成功后自动刷新历史记录列表。
        
- **2.6. Git 提交与合并**: 完成所有前端功能和组件后，提交代码并创建 PR。
    

#### **3. 自动化 (n8n): 完成流程闭环通知**

**目标**：配置 n8n 工作流，以自动通知相关人员案件生命周期的最后步骤。

- **3.1. n8n: 请求完成审批工作流**:
    
    - **触发器**: 创建一个新的 Webhook 节点，由后端的 "请求完成 API" 调用。
        
    - **逻辑**: 从 Webhook 获取 `CaseID`。
        
    - **执行器**: 使用 `Send Email` 节点，向所有拥有 `Chair` 角色的用户发送邮件，通知他们“案件 [CaseID] 已完成处理，等待您的最终审批”。
        
- **3.2. n8n: 最终结果通知工作流**:
    
    - **触发器**: 创建一个新的 Webhook 节点，由后端的 "最终审批 API" 调用。
        
    - **逻辑**: 从 Webhook 获取 `CaseID`、最终状态 (`Completed`/`Rejected`) 和 `AssignedCaseworkerID`。使用数据库节点查询该 Caseworker 的邮箱。
        
    - **执行器**: 使用 `Switch` 节点判断最终状态，然后发送不同内容的邮件给 Caseworker，例如“您处理的案件 [CaseID] 已被批准”或“...已被拒绝”。
        

#### **4. 自动化与开发运维 (Automation & DevOps)**

**目标**：确保新增功能的代码质量，并进行完整的端到端测试。

- **4.1. GitHub Actions**:
    
    - CI 流程将自动运行为本阶段新增的后端 API 编写的集成测试。
        
    - 确保所有 PR 在合并到 `develop` 分支前，都通过了代码审查和所有自动化检查。
        
- **4.2. 端到端测试 (E2E)**:
    
    - 在此阶段完成后，应手动执行一次完整的端到端测试。
        
    - **测试场景**:
        
        1. Clerk 创建一个新案件。
            
        2. Chair 收到通知，查看并指派给一个 Caseworker。
            
        3. Caseworker 收到通知，接受案件。
            
        4. Caseworker 完成工作，请求完成。
            
        5. Chair 收到通知，进行最终审批（批准）。
            
    - 验证每一步之后，相关人员是否都收到了正确的 n8n 邮件通知。
        

完成阶段 3 后，您的应用将具备一个完整、健壮、可追溯的案件管理核心流程。系统的所有核心功能都已实现。接下来，我们可以进入 **阶段 4**，专注于数据分析、报告和仪表板的开发，从数据中挖掘价值。